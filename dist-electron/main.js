"use strict";var v=Object.defineProperty;var I=(t,e,o)=>e in t?v(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var d=(t,e,o)=>I(t,typeof e!="symbol"?e+"":e,o);const a=require("electron"),A=require("node:path"),T=require("node:os"),M=require("node:worker_threads");class m{constructor(){d(this,"proxies",[]);d(this,"currentIndex",0)}setProxies(e){this.proxies=e,this.currentIndex=0}getNext(){if(this.proxies.length===0)return null;const e=this.proxies[this.currentIndex];return this.currentIndex=(this.currentIndex+1)%this.proxies.length,e}getCount(){return this.proxies.length}static parseProxyString(e){const o=e.trim();if(!o)return null;const i=o.match(/^(https?|socks5):\/\/(?:([^:]+):([^@]+)@)?([^:]+):(\d+)$/);if(i)return{protocol:i[1]==="socks5"?"socks5":"http",username:i[2]||void 0,password:i[3]||void 0,host:i[4],port:parseInt(i[5],10)};const r=o.split(":");return r.length>=2?{protocol:"http",host:r[0],port:parseInt(r[1],10),username:r[2]||void 0,password:r[3]||void 0}:null}static parseProxyList(e){return e.split(`
`).map(o=>m.parseProxyString(o)).filter(o=>o!==null)}static toPlaywrightProxy(e){return{server:`${e.protocol==="socks5"?"socks5":"http"}://${e.host}:${e.port}`,username:e.username,password:e.password}}static maskProxy(e){const o=e.host.replace(/(\d+)\.(\d+)\.(\d+)\.(\d+)/,"$1.***.***.$ 4");return`${e.protocol}://${o}:${e.port}`}}const y=[{width:1920,height:1080},{width:1366,height:768},{width:1536,height:864},{width:1440,height:900},{width:1280,height:720},{width:1600,height:900},{width:1280,height:800},{width:1024,height:768},{width:1680,height:1050},{width:1920,height:1200}],P=["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Safari/605.1.15","Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:122.0) Gecko/20100101 Firefox/122.0","Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36 Edg/121.0.0.0","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"],D=["Win32","MacIntel","Linux x86_64"],G=["en-US","en-GB","de-DE","fr-FR","ja-JP","ko-KR","es-ES","pt-BR"],R=["America/New_York","America/Chicago","America/Los_Angeles","Europe/London","Europe/Berlin","Europe/Paris","Asia/Tokyo","Asia/Seoul","Asia/Shanghai"],W=["Google Inc. (NVIDIA)","Google Inc. (AMD)","Google Inc. (Intel)","Google Inc. (Apple)"],N=["ANGLE (NVIDIA, NVIDIA GeForce RTX 3060 Direct3D11 vs_5_0 ps_5_0)","ANGLE (NVIDIA, NVIDIA GeForce GTX 1660 SUPER Direct3D11 vs_5_0 ps_5_0)","ANGLE (AMD, AMD Radeon RX 580 Direct3D11 vs_5_0 ps_5_0)","ANGLE (Intel, Intel(R) UHD Graphics 630 Direct3D11 vs_5_0 ps_5_0)","ANGLE (Apple, Apple M1 Pro, OpenGL 4.1)","ANGLE (Apple, Apple M2, OpenGL 4.1)"];function h(t){return t[Math.floor(Math.random()*t.length)]}function O(t,e){return Math.floor(Math.random()*(e-t+1))+t}const _=new Set;function C(){let t,e;do t={viewport:h(y),userAgent:h(P),hardwareConcurrency:O(2,16),platform:h(D),language:h(G),timezone:h(R),webglVendor:h(W),webglRenderer:h(N)},e=`${t.userAgent}-${t.viewport.width}-${t.hardwareConcurrency}`;while(_.has(e)&&_.size<100);return _.add(e),t}function $(){_.clear()}class b{constructor(e,o){d(this,"workers",new Map);d(this,"proxyController",new m);d(this,"onStatus");d(this,"onLog");this.onStatus=e,this.onLog=o}async startSessions(e){const o=e.proxies;this.proxyController.setProxies(o),$(),this.emitLog("info","Pool",`Starting ${e.sessionCount} sessions → ${e.targetUrl}`),o.length>0?this.emitLog("info","Pool",`Loaded ${o.length} proxies — round-robin rotation`):this.emitLog("warn","Pool","No proxies configured — using direct connection");for(let i=0;i<e.sessionCount;i++){const r=`W-${String(i+1).padStart(3,"0")}`,w=this.proxyController.getNext(),S=C(),k=A.join(__dirname,"BrowserWorker.js"),g=new M.Worker(k,{workerData:{id:r,targetUrl:e.targetUrl,proxy:w?m.toPlaywrightProxy(w):null,fingerprint:S}}),l={id:r,worker:g,status:{id:r,state:"idle",proxy:w?m.maskProxy(w):null,userAgent:S.userAgent,uptime:0,lastHeartbeat:Date.now(),error:null}};g.on("message",c=>{if(c.type==="status")l.status=c.payload,this.onStatus(l.status);else if(c.type==="log"){const L=c.payload;this.emitLog(L.level,r,L.message)}}),g.on("error",c=>{this.emitLog("error",r,`Worker crashed: ${c.message}`),l.status={...l.status,state:"error",error:c.message},this.onStatus(l.status)}),g.on("exit",c=>{c!==0&&l.status.state!=="stopped"&&(this.emitLog("warn",r,`Worker exited with code ${c}`),l.status={...l.status,state:"error",error:`Exit code ${c}`},this.onStatus(l.status)),this.workers.delete(r)}),this.workers.set(r,l),this.onStatus(l.status),await this.sleep(200)}this.emitLog("success","Pool",`All ${e.sessionCount} workers launched`)}stopWorker(e){const o=this.workers.get(e);o&&(this.emitLog("info","Pool",`Stopping worker ${e}`),o.worker.postMessage({type:"stop"}),setTimeout(()=>{this.workers.has(e)&&(o.worker.terminate(),this.workers.delete(e))},5e3))}stopAll(){this.emitLog("info","Pool",`Stopping all ${this.workers.size} workers`);for(const[e]of this.workers)this.stopWorker(e)}getActiveCount(){let e=0;for(const[,o]of this.workers)(o.status.state==="active"||o.status.state==="connecting")&&e++;return e}getTotalCount(){return this.workers.size}emitLog(e,o,i){this.onLog({timestamp:Date.now(),level:e,source:o,message:i})}sleep(e){return new Promise(o=>setTimeout(o,e))}}var p=(t=>(t.START_SESSIONS="sessions:start",t.STOP_SESSION="sessions:stop",t.STOP_ALL="sessions:stop-all",t.FETCH_PROXIES="proxies:fetch",t.GET_VERSION="app:version",t.CHECK_UPDATE="app:check-update",t.WORKER_UPDATE="worker:update",t.SYSTEM_STATS="system:stats",t.LOG="log:entry",t))(p||{});let s=null,n=null,f=null;const U=A.join(__dirname,"../dist"),K=A.join(__dirname),E=process.env.VITE_DEV_SERVER_URL;function x(){s=new a.BrowserWindow({width:1400,height:900,minWidth:1e3,minHeight:700,backgroundColor:"#0a0a0f",titleBarStyle:"hiddenInset",webPreferences:{preload:A.join(K,"preload.js"),contextIsolation:!0,nodeIntegration:!1}}),E?(s.loadURL(E),s.webContents.openDevTools()):s.loadFile(A.join(U,"index.html")),s.on("closed",()=>{s=null})}function V(){const t=T.cpus(),e=t.reduce((w,S)=>{const k=Object.values(S.times).reduce((l,c)=>l+c,0),g=S.times.idle;return w+(k-g)/k*100},0)/t.length,o=T.totalmem(),i=T.freemem(),r=o-i;return{cpuPercent:Math.round(e*10)/10,ramUsedMB:Math.round(r/1024/1024),ramTotalMB:Math.round(o/1024/1024),activeWorkers:(n==null?void 0:n.getActiveCount())??0,totalWorkers:(n==null?void 0:n.getTotalCount())??0}}function H(){f&&clearInterval(f),f=setInterval(()=>{s&&!s.isDestroyed()&&s.webContents.send(p.SYSTEM_STATS,V())},2e3)}function z(){a.ipcMain.handle(p.START_SESSIONS,async(t,e)=>{n||(n=new b(o=>{s==null||s.webContents.send(p.WORKER_UPDATE,o)},o=>{s==null||s.webContents.send(p.LOG,o)})),await n.startSessions(e)}),a.ipcMain.handle(p.STOP_SESSION,async(t,e)=>{n==null||n.stopWorker(e)}),a.ipcMain.handle(p.STOP_ALL,async()=>{n==null||n.stopAll()}),a.ipcMain.handle(p.FETCH_PROXIES,async(t,e)=>{const{fetchProxies:o}=await Promise.resolve().then(()=>require("./ProxyFetcher-T2L0xEPH.js"));return await o(e,r=>{s&&!s.isDestroyed()&&s.webContents.send(p.LOG,{timestamp:Date.now(),level:"info",source:"proxy-fetcher",message:r})})}),a.ipcMain.handle(p.GET_VERSION,()=>a.app.getVersion()),a.ipcMain.handle(p.CHECK_UPDATE,async()=>{var t;if(E)return u("info","updater","Auto-update not available in dev mode"),{updateAvailable:!1};try{const{autoUpdater:e}=require("electron-updater"),o=await e.checkForUpdates();return{updateAvailable:!!((t=o==null?void 0:o.updateInfo)!=null&&t.version)}}catch(e){const o=e instanceof Error?e.message:String(e);return u("warn","updater",`Update check failed: ${o}`),{updateAvailable:!1}}})}a.app.whenReady().then(()=>{x(),z(),H(),E||F(),a.app.on("activate",()=>{a.BrowserWindow.getAllWindows().length===0&&x()})});function F(){try{const{autoUpdater:t}=require("electron-updater");t.autoDownload=!0,t.autoInstallOnAppQuit=!0,t.on("checking-for-update",()=>{u("info","updater","Checking for updates...")}),t.on("update-available",e=>{u("success","updater",`Update v${e.version} available — downloading...`)}),t.on("update-not-available",()=>{u("info","updater",`App is up to date (v${a.app.getVersion()})`)}),t.on("download-progress",e=>{u("info","updater",`Downloading: ${Math.round(e.percent)}%`)}),t.on("update-downloaded",e=>{u("success","updater",`Update v${e.version} ready — will install on restart`)}),t.on("error",e=>{u("warn","updater",`Update check failed: ${e.message}`)}),setTimeout(()=>t.checkForUpdatesAndNotify(),5e3)}catch{}}function u(t,e,o){s&&!s.isDestroyed()&&s.webContents.send(p.LOG,{timestamp:Date.now(),level:t,source:e,message:o})}a.app.on("window-all-closed",()=>{n==null||n.stopAll(),f&&clearInterval(f),process.platform!=="darwin"&&a.app.quit()});
